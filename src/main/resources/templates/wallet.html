<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wallet</title>
    <link rel="stylesheet" href="/css/home.css">
    <link rel="stylesheet" href="/css/wallet.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<aside class="sidebar">
    <a href="/home" class="nav-item"><h1>Menu</h1></a>

    <a href="/children" class="nav-item">My Kids</a>
    <a href="/wallet" class="nav-item">Wallet</a>

    <h1>Settings</h1>

    <a href="/home/profile" class="nav-item">Edit Profile</a>
    <a href="/home/users" class="nav-item" th:if="${parent != null and parent.role != null and parent.role.displayName == 'Admin'}">Users</a>
    <a href="/logout" class="nav-item">Logout</a>
</aside>
<div class="wallet-container" th:with="p=${parent}">
    <section class="main-section">
        <div class="card profile-card">
    <header>
        <h1>Wallet</h1>
        <p th:text="${p != null ? p.firstName + ' ' + p.lastName : 'Guest'}">Parent Name</p>
    </header>

    <section class="balance">
        <h2>Available Balance</h2>
        <p class="amount" th:text="${p.wallet.balance + ' ' + p.wallet.currency}">
            0.00 EUR
        </p>
    </section>

            <section class="actions">
                <form th:action="@{/wallet}" th:object="${walletDepositRequest}" method="post" class="add-money-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <label for="amount">Enter Amount:</label>
                    <input type="number" id="amount" th:field="*{amount}" min="1" step="0.10" placeholder="0.00" required/>

                    <button type="submit" class="primary">Add Money</button>
                </form>
                <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
                <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
            </section>

        <section class="transactions" th:if="${transactions != null}">
            <h2>Transaction History</h2>
            <p class="subtitle">Showing latest 5 transactions.</p>
            <table class="transaction-table">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                </tr>
                </thead>
                <tbody id="transactionBody">
                <tr th:each="td : ${transactions}">
                    <td th:text="${#temporals.format(td.transaction.createdOn, 'dd-MM-yyyy HH:mm')}">12-10-2025</td>
                    <td>
                        <!-- Show child image and name for lunch-related transactions -->
                        <div th:if="${td.isLunchRelated and td.child != null}" class="transaction-child-info">
                            <img th:src="${td.child.imagePath != null ? td.child.imagePath : (td.child.gender.getDisplayName() == 'Boy' ? 'https://img.freepik.com/premium-vector/cute-boy-smiling-cartoon-kawaii-boy-illustration-boy-avatar-happy-kid_1001605-3446.jpg' : 'https://www.creativefabrica.com/wp-content/uploads/2022/09/20/Happy-girl-avatar-Funny-child-profile-p-Graphics-38924522-1.png')}"
                                 th:alt="${td.child.firstName}"
                                 class="transaction-child-avatar"
                                 onerror="this.src='https://via.placeholder.com/40/4682B4/ffffff?text=' + encodeURIComponent(this.alt)">
                            <div class="transaction-child-details">
                                <span th:text="${td.child.firstName}">Child Name</span>
                                <span class="transaction-child-name"
                                      th:text="${td.transaction.description != null and td.transaction.description.contains('Refund') ? 'cancelled lunch' : 'added lunch'}">
                                    added lunch
                                </span>
                            </div>
                        </div>
                        <span th:if="${!td.isLunchRelated or td.child == null}" th:text="${td.transaction.description}">Deposit</span>
                    </td>
                    <td>
                        <span th:class="${td.transaction.type.name() == 'PAYMENT' ? 'transaction-amount-payment' : 'transaction-amount-deposit'}"
                              th:text="${td.transaction.amount + ' ' + p.wallet.currency}">
                            10.00 EUR
                        </span>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(transactions)}">
                    <td colspan="3" >No transactions yet.</td>
                </tr>
                </tbody>
            </table>
        </section>

</div>
    </section>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const successAlert = document.querySelector(".alert-success");
        if (successAlert) {
            setTimeout(() => {
                successAlert.style.transition = "opacity 0.5s ease";
                successAlert.style.opacity = "0";
                setTimeout(() => successAlert.remove(), 500);
            }, 5000);
        }
    });
</script>
</div>
</body>
</html>
